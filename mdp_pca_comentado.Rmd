---
title: "mdp_pca"
author: "prado"
date: "2024-04-19"
output: html_document
---

```{r setup, include=FALSE}
library(readxl)
library(knitr)
library(dplyr)
library(FactoMineR)
library(factoextra)
library(grid)
library(gridExtra)
library(mice)
library(reshape2)
library(ggplot2)
```


```{r Carga Datos, include=FALSE}
# Hacemos la carga de datos y cambiamos los nombres de las columnas para poder identificarlas mejor a la hora de hacer los análisis.
knitr::opts_chunk$set(echo = TRUE)
daly=read_excel("Base_de_datos.xlsx")
nombres_sin_comillas <- c("Pais", "Codigo", "Año", "Autolesion", "F_Naturaleza", "Conflictos", "Vio_IntPer", "Enf_Tropicales", "Consumo_sustancias", "Enf_cutanea", "Inf_Entericas", "Diabetes", "Enf_cardiovasculares", "Enf_digestivas", "Def_Nutricion", "Inf_Respiratorias", "Des_Neonatales", "Enf_Resp_Cronicas", "Otras_Enf", "Des_Maternos", "Les_NoInt", "Des_MuscEsc", "Neoplasmas", "Des_mentales", "Des_Neuro", "ETS", "Les_Transporte", "Enf_OrgSens")
colnames(daly)=nombres_sin_comillas
head(daly, 3)
```



```{r Descripción Daly}
#Creamos un dataframe que nos indique el tipo de variables que tenemos en la base de datos.
desc_daly = data.frame("variable" = colnames(daly),
                       "tipo" = c("text", "text", "integer", rep("numerical", 25)), stringsAsFactors = FALSE)
```


```{r Arreglo Datos}
#Aplicamos una transformación a los datos que son numéricos (los porcentajes de DALY por enfermedad) y le sumamos 1 a los valores que sean 0 para poder aplicar el logaritmo
cent=daly[4:28]
cent = cent %>%  mutate_if(~ min(., na.rm = TRUE) == 0, ~ . + 1)
```

```{r Log Datos}
#Una vez hecho esto, aplicamos la función logaritmo a nuestros datos, porque tiene asimetría
log <- cent %>%
  mutate_if(is.numeric, list(~ log(.)))
```


```{r Datos Centrados}
#Hacemos el centrado de los datos para facilitar la incorporación, el escalado no es necesario porque las variables están medidas en las mismas unidades.
log=scale(log, center=TRUE, scale=FALSE)
log=as.data.frame(log)
```
```{r Datos Preparados}
#Añadimos las columnas de los países, sus códigos y los años
log_daly = cbind(daly[1:3], log)
```



```{r}
#Realizamos el PCA y viendo el gráfico de variabilidad explicada por cada componente resolvemos con coger 3 componentes principales.
res.pca <- PCA(log_daly, scale.unit = FALSE, graph = FALSE, ncp = 10, quali.sup=c(1,2,3))
eig.val <- get_eigenvalue(res.pca)
VPmedio = 100*(1/nrow(eig.val))
fviz_eig(res.pca, addlabels = TRUE) +
  geom_hline(yintercept=VPmedio, linetype=2, color="red")
```

```{r Contribución Individuos}
#Como vemos ahora la mayoría de las observaciones que más contribuyen a la primera componente son de Finlandia filas de [1861-1890] (por tener un valor muy negativo) y paises subdesarollados como Sudán del Sur y Uganda (que tienen valores muy altos)
#log_daly[c(1889,1890,1888,1887,1885,1886,5071, 5702, 1882, 5703,1861),]
fviz_contrib(res.pca, choice='ind', axes=c(1), top=10)
```
```{r PCA 3 comp}
#Hacemos ahora el PCA ccogiendo solo 3 CP
res.pca <- PCA(log_daly, scale.unit = FALSE, graph = FALSE, ncp = 3, quali.sup=c(1,2,3))
eig.val <- get_eigenvalue(res.pca)
VPmedio = 100*(1/nrow(eig.val))
fviz_eig(res.pca, addlabels = TRUE) +
  geom_hline(yintercept=VPmedio, linetype=2, color="red")
```


```{r}
fviz_pca_var(res.pca, axes = c(1,2), repel = TRUE, col.var="contrib",gradient.cols = c("#00AFBB","#E7B800","#FC4E07"))
fviz_pca_var(res.pca, axes = c(1,3), repel = TRUE, col.var="contrib",gradient.cols = c("#00AFBB","#E7B800","#FC4E07"))
fviz_pca_var(res.pca, axes = c(2,3), repel = TRUE, col.var="contrib",gradient.cols = c("#00AFBB","#E7B800","#FC4E07"))
```

```{r Detección Anómalos 1}
#Comprobamos si hay alguna observación anómala 
misScores = res.pca$ind$coord[,1:3]; misScores
miT2 = colSums(t(misScores**2)/eig.val[1:3,1])
I = nrow(log_daly)
F95 = 3*(I**2 - 1)/(I*(I - 3)) * qf(0.95, 4, I-3)
F99 = 3*(I**2 - 1)/(I*(I - 3)) * qf(0.99, 4, I-3)
plot(1:length(miT2), miT2, type = "p", xlab = "LOG_DALY", ylab = "T2")+
abline(h = F95, col = "orange", lty = 2, lwd = 2)+
abline(h = F99, col = "red3", lty = 2, lwd = 2)
```
Vemos que la observación 4505 es un outlier severo debido a su valor en la T2 de Hotelling. Eso quiere decir que el modelo está siendo modifcado significativamente para poder incluir a está observación. Revisando en nuestra base de datos apreciamos que está observación pertenece a Ruanda en el año 1994. Por lo tanto está observación se ve afectada por el genocidio de Ruanda, una masacre que aniquiló al 70% de la etnia tutsi y que no tiene comparación con ningún hecho ocurrido en los 30 años que abarca el dataset. Por lo tanto, consideramos que es más sensato eliminar está observación del modelo y volver a realizar el PCA.
```{r}
X = as.matrix(log)
misLoadings = sweep(res.pca$var$coord[,1:3], 2, sqrt(res.pca$eig[1:3,1]),FUN ="/")
myE = X - misScores %*% t(misLoadings)
mySCR = rowSums(myE^2)
plot(1:length(mySCR), mySCR, type = "l", main = "Distancia al modelo", ylab = "SCR", xlab = "Daly")
g = var(mySCR)/(2*mean(mySCR))
h = (2*mean(mySCR)^2)/var(mySCR)
chi2lim = g*qchisq(0.95,df=h)
chi2lim99 = g*qchisq(0.99,df=h)
abline(h=chi2lim, col="orange",lty=2,lwd=2)
abline(h=chi2lim99, col="red3",lty = 2, lwd=2)
```
Observamos que la observación 2331 es un outlier moderado, es decir, que no es explicada por el modelo. Esta observación corresponde al año 2010 en Haití, donde hubo un terremoto que supuso una gran tragedia humana en el país. Cómo no ha habido sucesos similares en los últimos 30 años esta observación no es explicada adecuadamente por el modelo. Al no ser un outlier severo no es necesario eliminarla.


```{r}
daly <- daly[-4505, ]
```

```{r}
cent=daly[4:28]
cent = cent%>%  mutate_if(~ min(., na.rm = TRUE) == 0, ~ . + 1)
cent
```
```{r}
log <- cent %>%
  mutate_if(is.numeric, list(~ log(.)))
log
```
```{r}
log=scale(log, center=TRUE, scale=FALSE)
log=as.data.frame(log); log
```

```{r}
log_daly = cbind(daly[1:3], log)
log_daly
```

```{r}
res.pca <- PCA(log_daly, scale.unit = FALSE, graph = FALSE, ncp = 3, quali.sup=c(1,2,3))
eig.val <- get_eigenvalue(res.pca)
eig.val
VPmedio = 100*(1/nrow(eig.val))
VPmedio
fviz_eig(res.pca, addlabels = TRUE) +
  geom_hline(yintercept=VPmedio, linetype=2, color="red")
```
```{r}
fviz_pca_var(res.pca, axes = c(1,2), repel = TRUE, col.var="contrib",gradient.cols = c("#00AFBB","#E7B800","#FC4E07"))
fviz_pca_var(res.pca, axes = c(1,3), repel = TRUE, col.var="contrib",gradient.cols = c("#00AFBB","#E7B800","#FC4E07"))
fviz_pca_var(res.pca, axes = c(2,3), repel = TRUE, col.var="contrib",gradient.cols = c("#00AFBB","#E7B800","#FC4E07"))
```
```{r}
misScores = res.pca$ind$coord[,1:3]; misScores
miT2 = colSums(t(misScores**2)/eig.val[1:3,1])
miT2
I = nrow(log_daly); I 
F95 = 3*(I**2 - 1)/(I*(I - 3)) * qf(0.95, 4, I-3)
F99 = 3*(I**2 - 1)/(I*(I - 3)) * qf(0.99, 4, I-3)
plot(1:length(miT2), miT2, type = "p", xlab = "LOG_DALY", ylab = "T2")
abline(h = F95, col = "orange", lty = 2, lwd = 2)
abline(h = F99, col = "red3", lty = 2, lwd = 2)
```
Dado que contamos con una base de datos de 6149 observaciones, está distribución de la T2 de Hotelling es aceptable. Aceptamos que haya países que tomen valores extremos en ciertas variables y deformen ligeramente el modelo. Es preferible a esta situación a una donde la contribución de una sola observación opaca la contribución del resto de observaciones. 
```{r}
X = as.matrix(log)
misLoadings = sweep(res.pca$var$coord[,1:3], 2, sqrt(res.pca$eig[1:3,1]),FUN ="/")
myE = X - misScores %*% t(misLoadings)
mySCR = rowSums(myE^2)
plot(1:length(mySCR), mySCR, type = "l", main = "Distancia al modelo", ylab = "SCR", xlab = "Daly")
g = var(mySCR)/(2*mean(mySCR))
h = (2*mean(mySCR)^2)/var(mySCR)
chi2lim = g*qchisq(0.95,df=h)
chi2lim99 = g*qchisq(0.99,df=h)
abline(h=chi2lim, col="orange",lty=2,lwd=2)
abline(h=chi2lim99, col="red3",lty = 2, lwd=2)
```

Podemos aceptar que una observación no esté explicada correctamente por el modelo, ya que entendemos que el terremoto de Haití y sus consecuencias son un hecho anómalo. Esta observación no modifica el modelo por lo que no supone un problema.